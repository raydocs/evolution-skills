# 通用自我进化系统

此系统让 Droid 在开发过程中持续学习并改进知识库。

---

## 自动触发 vs 手动触发

**重要**: 某些机制应该自动触发，无需用户请求。

### 自动触发 (Droid 主动执行)

| 机制 | 何时自动触发 |
|------|-------------|
| **版本适配** | 会话开始时，检测项目依赖版本 |
| **个性化** | 首次生成代码时，扫描 2-3 个现有文件了解风格 |
| **自我修正** | 当 skill 建议的代码失败时立即触发 |
| **使用反馈** | 每次使用模式后（成功或失败） |

### 半自动触发 (Droid 提议，用户确认)

| 机制 | 何时提议 |
|------|---------|
| **自我进化** | 解决了值得记录的非平凡问题后 |

### 手动触发 (用户必须请求)

| 机制 | 触发短语 |
|------|---------|
| **自我验证** | "验证 skills" |
| **健康报告** | "显示模式健康报告" |

---

## 会话开始检查清单 (自动执行)

开始开发会话时，Droid 应自动:

```
1. [ ] 从 package.json/Cargo.toml/pubspec.yaml 等检测框架版本
      → 设置内部上下文: "使用 {框架} {版本}"

2. [ ] 扫描项目风格 (如果之前没做过)
      → 记录命名规范、模块结构

3. [ ] 应用版本特定和个性化的建议
      → 所有后续建议自动适配
```

**Droid: 静默执行这些。除非与用户问题相关，否则不要宣布。**

---

## 何时进化

当开发过程中发生以下任何情况时触发 skill 进化:

| 触发条件 | 目标文件 | 优先级 |
|---------|---------|-------|
| 发现新的 UI 组件模式 | {tech}-patterns.md | 高 |
| 学到新的架构技术 | {tech}-architecture.md | 高 |
| 解决了编译/运行时错误 | {tech}-troubleshooting.md | 高 |
| 找到布局/响应式方案 | {tech}-layout.md | 中 |
| 解决了构建/部署问题 | {tech}-build.md | 中 |
| 理清了核心概念 | {tech}-fundamentals.md | 低 |

其中 `{tech}` 是技术栈名称，如 `flutter`、`swiftui`、`react`、`rust` 等。

---

## 进化流程

### Step 1: 识别值得捕获的知识

问自己:
- 这是可复用的模式吗？(不是项目特定的)
- 花了很大力气才弄清楚吗？
- 会帮助其他开发者吗？
- 还没有记录在 skills 中吗？

### Step 2: 分类知识

```
UI 组件/Widget 模式  → ~/.factory/skills/{tech}-patterns.md
架构/状态管理模式    → ~/.factory/skills/{tech}-architecture.md
错误/调试解决方案    → ~/.factory/skills/{tech}-troubleshooting.md
布局/响应式设计      → ~/.factory/skills/{tech}-layout.md
构建/部署问题        → ~/.factory/skills/{tech}-build.md
核心概念/API         → ~/.factory/skills/{tech}-fundamentals.md
```

### Step 3: 格式化贡献

**模式格式**:
```markdown
## 模式 N: [模式名称]

简要描述这个模式解决什么问题。

### 代码示例

\```{language}
// 代码
\```

### 使用场景

- 场景 1
- 场景 2

### 注意事项

- 注意点 1
```

**问题解决格式**:
```markdown
### [错误类型/消息]

**症状**: 开发者看到什么

**原因**: 为什么发生

**解决方案**:
\```{language}
// 修复后的代码
\```

**相关版本**: {框架} {版本}
```

### Step 4: 更新 Skill 文件

1. 读取目标 skill 文件 (如果存在)
2. 找到适当的部分
3. 按现有格式添加新内容
4. 确保没有重复内容
5. 如果文件不存在，创建它

### Step 5: 添加进化标记

```markdown
<!-- evolution: {date} | source: {project} | trigger: {what-happened} -->
```

将此注释放在你添加的新内容上方。

---

## Skill 文件位置

### 目录结构

```
~/.factory/skills/
├── evolution.md              # 本文件 - 主控制
├── flutter-patterns.md       # Flutter UI 模式
├── flutter-troubleshooting.md
├── swiftui-patterns.md       # SwiftUI 模式
├── swiftui-troubleshooting.md
├── react-patterns.md         # React 模式
├── rust-patterns.md          # Rust 模式
└── project-styles/
    └── {project-name}.md     # 项目特定风格
```

### 创建新的 Skill 文件

当遇到新技术栈时，创建对应的文件:

```bash
# 示例: 创建 Vue 相关 skills
touch ~/.factory/skills/vue-patterns.md
touch ~/.factory/skills/vue-troubleshooting.md
```

文件开头模板:
```markdown
# {Tech} Patterns

此文件记录 {Tech} 开发中发现的可复用模式。

---

## 模式列表

(模式将在开发过程中自动添加)
```

---

## 自我修正 (Self-Correction)

当 skill 内容导致错误时，自动修正。

**自动触发: 是** - Droid 应在错误发生时自动修正 skills。

### 触发条件

```
用户遵循 skill 建议 → 代码编译/运行失败 → Droid 识别 skill 是错的
                                              ↓
                                    自动: 立即修正 skill
```

### Droid 自动行为

当 Droid 检测到 skill 中的代码导致错误时:

1. **识别** - "这个错误是因为 skill 建议是错的"
2. **修复用户代码** - 提供正确的解决方案
3. **更新 skill** - 自动编辑 skill 文件 (无需询问)
4. **通知用户** - "我也更新了 skills 以防止其他人遇到这个错误"

### 修正标记格式

```markdown
<!-- correction: {date} | was: {old-code-summary} | now: {new-code-summary} | reason: {why} -->
```

---

## 自我验证 (Self-Validation)

定期验证 skill 内容是否仍然准确。

### 验证触发

| 触发条件 | 动作 |
|---------|------|
| 用户说 "验证 skills" | 完整验证 |
| 使用 skill 代码编译失败 | 针对性验证 |
| 检测到新框架版本 | API 验证 |

### 验证检查清单

```markdown
## 验证报告

### 代码示例
- [ ] 所有代码示例可以编译
- [ ] 所有模式按文档工作

### API 准确性
- [ ] API 签名正确
- [ ] 方法名称正确

### 完整性
- [ ] 没有过时的模式 (无警告)
- [ ] 没有遗漏的常见用例
```

---

## 使用反馈 (Usage Feedback)

跟踪哪些模式有效，哪些导致问题。

**自动触发: 是** - Droid 应在使用模式后自动记录反馈。

### Droid 自动行为

使用 skills 中的任何模式后:

1. **静默跟踪** - 不要向用户宣布反馈记录
2. **成功时** - 更新标记: `success += 1`
3. **失败时** - 更新标记: `failed += 1`，然后触发自我修正
4. **定期** - 如果模式失败 3+ 次，主动建议修复

### 反馈标记格式

在模式开头添加:

```markdown
<!-- feedback: count=5 | success=4 | failed=1 | last_used=2026-01-10 -->
## 模式 N: ...
```

### 健康报告

用户可以请求:

```
"显示模式健康报告"
```

输出:
```markdown
## 模式健康报告

| 模式 | 使用次数 | 成功 | 失败 | 成功率 | 状态 |
|------|---------|------|------|-------|------|
| Flutter 下拉刷新 | 10 | 9 | 1 | 90% | ✅ 健康 |
| SwiftUI 导航 | 5 | 3 | 2 | 60% | ⚠️ 需审查 |
| React useEffect 清理 | 3 | 0 | 3 | 0% | ❌ 可能损坏 |
```

| 成功率 | 动作 |
|-------|------|
| > 90% | 模式稳定，无需动作 |
| 70-90% | 审查模式的边缘情况 |
| 50-70% | 模式需要改进 |
| < 50% | 模式可能损坏，需修复或移除 |

---

## 版本适配 (Version Adaptation)

为不同框架版本提供特定指导。

**自动触发: 是** - Droid 应在会话开始时检测版本。

### Droid 自动行为

在任何开发会话开始时:

1. **读取配置文件** - 查找依赖版本
   - Flutter: `pubspec.yaml`
   - Node.js: `package.json`
   - Rust: `Cargo.toml`
   - Swift: `Package.swift` 或 Xcode 项目
   
2. **提取版本** - 记录主要框架版本

3. **设置上下文** - 记住这个用于所有后续建议

4. **静默适配** - 不要宣布，只使用正确的 API

5. **不匹配时警告** - 如果用户代码使用错误的 API，解释版本差异

### 版本特定内容格式

在 skill 文件中:

```markdown
### 某个功能

<!-- version: flutter>=3.0 -->
\```dart
// Flutter 3.0+ 的写法
\```

<!-- version: flutter<3.0 -->
\```dart  
// Flutter 3.0 之前的写法
\```
```

---

## 个性化 (Personalization)

使 skill 建议适应项目的编码风格。

**自动触发: 是** - Droid 应在首次生成代码时检测项目风格。

### Droid 自动行为

首次请求生成代码时:

1. **快速扫描** - 读取项目中 2-3 个现有文件
2. **记录模式** - 命名规范、模块结构、注释风格
3. **记住** - 存储在对话上下文中
4. **应用** - 所有生成的代码匹配项目风格
5. **静默** - 不要向用户宣布此分析

### 风格检测

| 方面 | 检测方法 | 适配 |
|-----|---------|------|
| 命名规范 | 扫描现有代码 | 匹配 snake_case vs camelCase |
| 代码组织 | 检查模块结构 | 建议匹配的模式 |
| 注释风格 | 读取现有注释 | 匹配文档风格 |
| 复杂度 | 计算每文件行数 | 建议适当的模式 |

### 项目风格档案

为每个项目保存风格到 `~/.factory/skills/project-styles/{project}.md`:

```markdown
# {Project} 风格档案

- **命名规范**: camelCase
- **模块组织**: feature-first
- **状态管理**: BLoC
- **注释风格**: 简洁
- **复杂度偏好**: 小组件
```

---

## 自动进化提示

这些提示触发自我进化:

### 解决问题后

> "这个解决方案应该添加到 skills 供将来参考。"

### 创建组件后

> "这个组件模式可复用。让我添加到 {tech}-patterns。"

### 调试后

> "这个错误和修复应该记录到 {tech}-troubleshooting。"

### 完成功能后

> "回顾我学到的内容，如果适用就更新 skills。"

---

## 质量指南

### 应该添加

- 通用、可复用的模式
- 常见错误及清晰解决方案
- 经过测试的效果/技术
- 平台特定的注意事项
- 性能优化

### 不应该添加

- 项目特定的代码
- 未验证的解决方案
- 重复内容
- 不完整的示例
- 没有理由的个人偏好

---

## 持续改进检查清单

每次开发会话后，考虑:

- [ ] 我发现了新的组件/模式吗？
- [ ] 我解决了棘手的问题吗？
- [ ] 我遇到并修复了令人困惑的错误吗？
- [ ] 我找到了更好的方式来组织代码吗？
- [ ] 我学到了关于构建/部署的东西吗？
- [ ] 这些会帮助其他开发者吗？

如果任何一个是肯定的，进化适当的 skill！

---

## 综合自我改进工作流

所有机制协同工作:

```
┌─────────────────┐
│   开发会话     │
└────────┬────────┘
         │
┌────────┴────────┬─────────────────┐
│                 │                 │
▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  个性化     │  │  使用模式   │  │  检测版本   │
│  建议       │  │             │  │             │
└─────────────┘  └──────┬──────┘  └─────────────┘
                        │
         ┌──────────────┼──────────────┐
         │              │              │
         ▼              ▼              ▼
   ┌──────────┐  ┌──────────┐  ┌──────────┐
   │  成功    │  │  失败    │  │  新模式  │
   │  +1      │  │  +1      │  │  发现    │
   └──────────┘  └────┬─────┘  └────┬─────┘
                      │              │
                      ▼              ▼
               ┌──────────┐  ┌──────────┐
               │  自我    │  │  自我    │
               │  修正    │  │  进化    │
               └──────────┘  └──────────┘
                      │              │
                      └──────┬───────┘
                             │
                             ▼
                      ┌─────────────┐
                      │   改进的    │
                      │   Skills    │
                      └─────────────┘
